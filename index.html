<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CISA Command Center v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <style>
        :root { --background: #f8f9fa; --text-primary: #1f2937; --text-secondary: #4b5563; --card-bg: #ffffff; --primary: #4f46e5; --primary-hover: #4338ca; --secondary: #64748b; --secondary-hover: #475569; --border: #e5e7eb; }
        html.dark { --background: #111827; --text-primary: #f9fafb; --text-secondary: #9ca3af; --card-bg: #1f2937; --primary: #6366f1; --primary-hover: #4f46e5; --border: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }
        .card { background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; transition: background-color 0.3s; border: 1px solid var(--border); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .answer-btn { width: 100%; text-align: left; padding: 1rem; margin-top: 0.5rem; border: 1px solid var(--border); background-color: var(--card-bg); }
        .answer-btn:hover:not(:disabled) { border-color: var(--primary); background-color: rgba(79, 70, 229, 0.1); }
        .answer-btn.correct { border-color: #16a34a; background-color: rgba(22, 163, 74, 0.1); }
        .answer-btn.incorrect { border-color: #dc2626; background-color: rgba(220, 38, 38, 0.1); }
        .hidden { display: none; }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { min-width: 320px; max-width: 600px; }
        .ach.unlocked { opacity: 1; border-style: solid; }
        .ach { opacity: 0.4; border-style: dashed; }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold">CISA Command Center</h1>
            <p class="text-secondary mt-2">Your AI-powered path to CISA certification.</p>
        </header>

        <!-- Main Menu -->
        <main id="mainMenu" class="card">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold">// Mission Parameters</h2><button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg><svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="quizType" class="block text-sm font-medium text-secondary">Select Quiz Type:</label><select id="quizType" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-transparent border-gray-300 dark:border-gray-600"><option value="mixed-10">Standard Protocol (10 Mixed)</option><option value="domain1">Domain 1: Auditing Process (5)</option><option value="domain2">Domain 2: Governance & IT Mgmt (5)</option><option value="domain3">Domain 3: IS Acquisition & Dev (5)</option><option value="domain4">Domain 4: IS Ops & Resilience (5)</option><option value="domain5">Domain 5: Info Asset Protection (5)</option><option value="weak-areas">Target Weak Areas (10)</option><option value="complex-scenario">Complex Scenario (5 Multi-Domain)</option></select></div>
                <div class="flex items-end"><button id="startQuizBtn" class="btn btn-primary w-full">Initialize Mission</button></div>
            </div>
            <div class="mt-4"><button id="dailyFocusBtn" class="btn btn-primary w-full bg-green-600 hover:bg-green-700">üéØ Daily Focus</button></div>
            <div class="mt-6 flex justify-center items-center space-x-4"><button id="serviceRecordBtn" class="btn btn-secondary">// Service Record</button><button id="systemBtn" class="btn btn-secondary">// System</button></div>
        </main>

        <!-- Quiz Panel -->
        <section id="quizPanel" class="card hidden">
            <div id="loader" class="text-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 dark:border-gray-100 mx-auto"></div><p class="mt-4 text-secondary">AI is generating your questions...</p></div>
            <div id="quizContent" class="hidden">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Active Mission</h2><div class="flex items-center space-x-4"><span id="streakCounter" class="font-mono text-lg hidden">üî• 0</span><button id="exitQuizBtn" class="btn btn-secondary">Exit</button></div></div>
                <div class="mb-4"><div class="flex justify-between mb-1"><span id="progressText" class="text-sm font-medium text-secondary">Question 1 of 10</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div></div></div>
                <div id="questionArea"><h3 id="questionText" class="text-xl font-medium mb-4"></h3><div id="answers" class="space-y-2"></div></div>
                <div id="explanationArea" class="mt-6 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg hidden"><h4 class="font-bold text-lg">Explanation</h4><p id="explanationText" class="mt-2 text-secondary"></p></div>
                <div class="mt-6 flex justify-between items-center">
                    <button id="prevBtn" class="btn btn-secondary">‚è™ Previous</button>
                    <button id="aiAssistBtn" class="btn btn-primary text-sm py-2 px-3" disabled title="Answer the question to enable AI Assist">ü§ñ AI Assist</button>
                    <button id="nextBtn" class="btn btn-primary">Next ‚è©</button>
                </div>
            </div>
        </section>

        <!-- Results/Review Panels -->
        <section id="resultsPanel" class="card hidden"><h2 class="text-2xl font-semibold text-center mb-4">Mission Debrief</h2><div id="finalScore" class="text-center text-3xl font-bold mb-2"></div><div id="xpGained" class="text-center text-lg text-green-600 font-semibold mb-6"></div><div class="mb-6"><h3 class="text-lg font-semibold mb-2">Performance by Domain:</h3><div id="domainPerformance" class="space-y-2"></div></div><div class="text-center space-x-4"><button id="reviewMissionBtn" class="btn btn-secondary">Review Mission</button><button id="restartBtn" class="btn btn-primary">New Mission</button></div></section>
        <section id="reviewPanel" class="card hidden"><h2 class="text-2xl font-semibold text-center mb-6">Mission Review</h2><div id="reviewQuestionsContainer" class="space-y-6"></div><div class="mt-6 text-center"><button id="backToResultsBtn" class="btn btn-primary">Back to Debrief</button></div></section>

        <!-- Service Record & System Panels -->
        <section id="serviceRecordPanel" class="card hidden">
            <h2 class="text-2xl font-semibold text-center mb-6">// Service Record</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center"><div class="card bg-gray-100 dark:bg-gray-800"><h3 class="font-semibold text-lg mb-2">Rank</h3><div id="rankBadge" class="text-5xl">üéñÔ∏è</div><div id="rankName" class="text-2xl font-bold mt-2">Cadet</div></div><div class="card bg-gray-100 dark:bg-gray-800"><h3 class="font-semibold text-lg mb-2">Experience Points</h3><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mt-4"><div id="xpBar" class="bg-green-500 h-4 rounded-full text-xs text-white flex items-center justify-center" style="width: 10%"></div></div><div id="xpText" class="text-sm mt-2 text-secondary">10 / 100 XP</div></div></div>
            <div class="mt-6 card bg-gray-100 dark:bg-gray-800"><h3 class="text-xl font-semibold text-center mb-4">// Commendations</h3><div id="achGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div></div>
            <div class="mt-6 text-center"><button class="backToMenuBtn btn btn-secondary">Return to Menu</button></div>
        </section>
        <section id="systemPanel" class="card hidden"><h2 class="text-2xl font-semibold text-center mb-6">// System & Data</h2><div class="space-y-4"><div><h3 class="font-semibold">API Key Status</h3><div class="flex items-center space-x-2 mt-2"><button id="checkApiKeyBtn" class="btn btn-primary text-sm py-2 px-3">Check Connection</button><span id="apiKeyStatus" class="text-sm font-mono">Status: UNCHECKED</span></div></div><div><h3 class="font-semibold">Local Data</h3><p class="text-sm text-secondary">Your progress is saved in this browser. Resetting will clear all stats, rank, and XP.</p><button id="resetStatsBtn" class="btn btn-secondary mt-2 text-sm py-2 px-3 bg-red-600 hover:bg-red-700">Reset All Stats</button></div></div><div class="mt-6 text-center"><button class="backToMenuBtn btn btn-secondary">Return to Menu</button></div></section>
    </div>
    
    <!-- Modals -->
    <div id="aiAssistModal" class="modal-backdrop hidden"><div class="modal-content card"><h3 class="text-xl font-semibold mb-4">AI Assistant</h3><div id="aiAssistLoader" class="text-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-gray-100 mx-auto"></div><p class="mt-2 text-sm text-secondary">Thinking...</p></div><div id="aiAssistResponse" class="prose max-w-none hidden text-secondary"></div><div class="text-right mt-4"><button id="closeAiAssistModal" class="btn btn-secondary">Close</button></div></div></div>
    <div id="exitModal" class="modal-backdrop hidden"><div class="modal-content card text-center"><h3 class="text-xl font-semibold mb-4">Exit Mission?</h3><p class="text-secondary mb-6">Your progress in this mission will be lost. Lifetime stats will be saved.</p><div class="flex justify-center space-x-4"><button id="cancelExitBtn" class="btn btn-secondary">Cancel</button><button id="confirmExitBtn" class="btn btn-primary bg-red-600 hover:bg-red-700">Confirm Exit</button></div></div></div>

    <script>
        // --- CONFIGURATION ---
        const RANKS = [{name:'Cadet',xp:0,badge:'üéñÔ∏è'},{name:'Ensign',xp:100,badge:'‚≠ê'},{name:'Lieutenant',xp:300,badge:'‚≠ê‚≠ê'},{name:'Commander',xp:700,badge:'üöÄ'},{name:'Captain',xp:1500,badge:'üåü'},{name:'Admiral',xp:3000,badge:'üèÜ'}];
        const ACHIEVEMENTS = { first_mission:{name:'First Mission',desc:'Complete a quiz.'}, quick_learner:{name:'Quick Learner',desc:'Get 10 correct answers.'}, persistent_analyst:{name:'Persistent Analyst',desc:'Answer 100 total questions.'}, perfectionist:{name:'Perfectionist',desc:'Score 100% on a quiz of 10+ Qs.'} };

        // --- STATE MANAGEMENT ---
        let state = { currentView:'mainMenu', currentQuiz:[], currentIndex:0, userResponses:[], currentStreak:0, stats:{ totalQuestions:0, correctAnswers:0, xp:0, achievements:[], dailyFocus:{date:null, count:0}, performance:{ domain1:{c:0,t:0}, domain2:{c:0,t:0}, domain3:{c:0,t:0}, domain4:{c:0,t:0}, domain5:{c:0,t:0} } } };
        const CISA_DOMAINS = { domain1:{n:"Auditing Process"}, domain2:{n:"Governance & IT Mgmt"}, domain3:{n:"IS Acquisition & Dev"}, domain4:{n:"IS Ops & Resilience"}, domain5:{n:"Info Asset Protection"} };

        // --- DOM ELEMENTS & HELPERS ---
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        const today = () => new Date().toISOString().split('T')[0];

        // --- UI & THEME ---
        function renderView(view) { state.currentView = view; $$('[id$="Panel"], #mainMenu').forEach(el => el.classList.add('hidden')); $(`#${view}`).classList.remove('hidden'); if (view === 'serviceRecordPanel') updateServiceRecordUI(); if (view === 'mainMenu') updateDailyFocusBtn(); }
        function showLoader(show) { $('#loader').classList.toggle('hidden', !show); $('#quizContent').classList.toggle('hidden', show); }
        const applyTheme = (theme) => { document.documentElement.classList.toggle('dark', theme === 'dark'); $('#theme-icon-light').classList.toggle('hidden', theme === 'dark'); $('#theme-icon-dark').classList.toggle('hidden', theme !== 'dark'); localStorage.setItem('theme', theme); };
        $('#themeToggle').addEventListener('click', () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));

        // --- API INTERACTION (via Netlify Function) ---
        async function callGemini(prompt, isJson = true) {
            try {
                const response = await fetch('/.netlify/functions/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, isJson })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Netlify Function Error: ${response.status} ${errorBody}`);
                }
                
                return await response.json();

            } catch (error) {
                console.error("callGemini failed:", error);
                // Fallback to mock data if the function fails
                if (isJson) {
                    alert("There was an error connecting to the AI. Using fallback questions.");
                    return { questions: generateMockQuestions() };
                }
                return { text: "Sorry, an error occurred with the AI request." };
            }
        }
        function generateMockQuestions() { return [ { "question": "What is the primary purpose of an IS audit charter? (Mock)", "options": ["Document procedures", "Outline audit cost", "Grant authority, scope, and responsibilities.", "List stakeholders."], "answer": 2, "explanation": "The charter formally establishes mandate, authority, independence, and scope for the audit function.", "domain": "domain1" }, { "question": "A primary goal of IT governance is to: (Mock)", "options": ["Have the latest tech", "Align IT with business strategy.", "Minimize IT spend", "Run the help desk."], "answer": 1, "explanation": "IT governance ensures IT enables and supports business objectives.", "domain": "domain2" } ]; }

        // --- QUIZ LOGIC ---
        async function startQuiz(isDailyFocus = false) {
            renderView('quizPanel'); showLoader(true);
            const quizType = isDailyFocus ? 'daily' : $('#quizType').value;
            const prompt = buildPromptForQuizType(quizType);
            const response = await callGemini(prompt, true);
            const questions = response.questions;
            if (!questions || questions.length === 0) { showLoader(false); renderView('mainMenu'); alert("AI failed to generate questions. Please try again."); return; }
            if (isDailyFocus) { 
                if (state.stats.dailyFocus.date !== today()) {
                    state.stats.dailyFocus.date = today();
                    state.stats.dailyFocus.count = 0;
                }
                state.stats.dailyFocus.count++;
                saveStats(); 
            }
            state.currentQuiz = questions; state.currentIndex = 0; state.userResponses = Array(questions.length).fill(null); state.currentStreak = 0;
            showLoader(false); renderQuestion();
        }

        function buildPromptForQuizType(type) {
            const base = `You are an expert CISA exam content creator. Generate high-quality, scenario-based multiple-choice questions. Each question must have four options, a single correct answer index (0-3), a detailed explanation, and the relevant CISA domain key (e.g., 'domain1'). Distractors must be plausible but incorrect.`;
            if (type.startsWith('domain')) { const d = type; return `${base} Generate 5 questions for CISA ${d}: ${CISA_DOMAINS[d].n}.`; }
            if (type === 'weak-areas') { const weak = getWeakAreas(); if (weak.length === 0) { alert("No weak areas identified. Starting a standard quiz."); return `${base} Generate 10 questions from a mix of all CISA domains.`; } return `${base} Generate 10 questions targeting the user's weak areas: ${weak.map(d => CISA_DOMAINS[d].n).join(', ')}.`; }
            if (type === 'complex-scenario') { return `You are an expert CISA exam creator specializing in integrated risk scenarios. Generate 5 complex, scenario-based questions that require applying knowledge from TWO different CISA domains. For each, specify the primary domain. The question should ask for the BEST course of action. The correct answer must address both domains. Distractors should plausibly address only one domain. ${base}`; }
            if (type === 'daily') { return `You are an expert CISA exam creator. Generate ONE very challenging, thought-provoking, scenario-based question that tests deep application of CISA principles, potentially integrating multiple concepts. The scenario should be realistic for a senior IT professional. ${base}`; }
            return `${base} Generate 10 questions from a mix of all five CISA domains.`;
        }

        function getWeakAreas() { return Object.entries(state.stats.performance).filter(([_, p]) => p.t >= 5 && (p.c / p.t) < 0.6).map(([d, _]) => d); }

        function renderQuestion() {
            updateProgress();
            const q = state.currentQuiz[state.currentIndex];
            $('#questionText').textContent = q.question;
            const answersContainer = $('#answers');
            answersContainer.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<strong>${String.fromCharCode(65 + i)}</strong>. ${opt}`;
                btn.className = 'btn answer-btn';
                btn.dataset.index = i;
                btn.onclick = () => selectAnswer(i);
                answersContainer.appendChild(btn);
            });
            const response = state.userResponses[state.currentIndex];
            $('#aiAssistBtn').disabled = response === null;
            if (response !== null) {
                showExplanation();
                $$('.answer-btn').forEach(btn => {
                    btn.disabled = true;
                    const btnIndex = parseInt(btn.dataset.index);
                    if (btnIndex === q.answer) btn.classList.add('correct');
                    else if (btnIndex === response.selectedIndex) btn.classList.add('incorrect');
                });
            } else {
                $('#explanationArea').classList.add('hidden');
            }
        }

        function selectAnswer(selectedIndex) {
            const q = state.currentQuiz[state.currentIndex];
            const isCorrect = selectedIndex === q.answer;
            if (state.userResponses[state.currentIndex] === null) {
                if (isCorrect) { state.stats.xp += 10; state.currentStreak++; } else { state.currentStreak = 0; }
                state.stats.totalQuestions++;
                const domainStats = state.stats.performance[q.domain];
                if (domainStats) { domainStats.t++; if (isCorrect) domainStats.c++; }
            }
            state.userResponses[state.currentIndex] = { question: q, selectedIndex, isCorrect };
            saveStats();
            renderQuestion();
        }
        
        function showExplanation() { $('#explanationArea').classList.remove('hidden'); $('#explanationText').textContent = state.currentQuiz[state.currentIndex].explanation; }
        function navigate(direction) { const newIndex = state.currentIndex + direction; if (newIndex >= 0 && newIndex < state.currentQuiz.length) { state.currentIndex = newIndex; renderQuestion(); } else if (newIndex >= state.currentQuiz.length) { finishQuiz(); } }
        function updateProgress() {
            const progress = ((state.currentIndex + 1) / state.currentQuiz.length) * 100;
            $('#progressBar').style.width = `${progress}%`;
            $('#progressText').textContent = `Question ${state.currentIndex + 1} of ${state.currentQuiz.length}`;
            $('#prevBtn').disabled = state.currentIndex === 0;
            $('#nextBtn').textContent = state.currentIndex === state.currentQuiz.length - 1 ? 'Finish Mission üèÅ' : 'Next ‚è©';
            $('#streakCounter').textContent = `üî• ${state.currentStreak}`;
            $('#streakCounter').classList.toggle('hidden', state.currentStreak === 0);
        }
        function finishQuiz() { checkAchievements(); renderView('resultsPanel'); renderResults(); }
        
        // --- RESULTS, REVIEW & GAMIFICATION ---
        function renderResults() {
            const correctCount = state.userResponses.filter(r => r && r.isCorrect).length;
            const totalCount = state.currentQuiz.length;
            const score = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
            const xpGained = correctCount * 10;
            $('#finalScore').textContent = `Score: ${correctCount} / ${totalCount} (${score}%)`;
            $('#xpGained').textContent = `+${xpGained} XP Gained!`;
            const perfContainer = $('#domainPerformance'); perfContainer.innerHTML = '';
            Object.entries(state.stats.performance).forEach(([d, p]) => { if (p.t > 0) { const acc = Math.round((p.c / p.t) * 100); perfContainer.innerHTML += `<p class="font-medium">${CISA_DOMAINS[d].n}: ${acc}% (${p.c}/${p.t})</p><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${acc}%"></div></div>`; } });
        }
        function showReview() {
            renderView('reviewPanel');
            const container = $('#reviewQuestionsContainer'); container.innerHTML = '';
            state.userResponses.forEach((resp, index) => {
                if (!resp) return; const q = resp.question, isCorrect = resp.isCorrect, userAns = String.fromCharCode(65 + resp.selectedIndex), correctAns = String.fromCharCode(65 + q.answer);
                container.innerHTML += `<div class="card border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-1 text-sm text-secondary">${q.options.map((opt, i) => `<p class="${i === q.answer ? 'text-green-500 font-bold' : ''} ${i === resp.selectedIndex && !isCorrect ? 'text-red-500' : ''}">${String.fromCharCode(65 + i)}. ${opt}</p>`).join('')}</div><p class="mt-2 text-sm">You answered: ${userAns}. Correct answer: ${correctAns}.</p><details class="mt-2 text-sm"><summary class="cursor-pointer">Explanation</summary><p class="mt-1 p-2 bg-gray-100 dark:bg-gray-800 rounded">${q.explanation}</p></details></div>`;
            });
        }
        function updateServiceRecordUI() {
            const rank = [...RANKS].reverse().find(r => state.stats.xp >= r.xp) || RANKS[0];
            const nextRank = RANKS.find(r => r.xp > rank.xp);
            $('#rankBadge').textContent = rank.badge; $('#rankName').textContent = rank.name;
            if (nextRank) { const prog = state.stats.xp - rank.xp, goal = nextRank.xp - rank.xp, pct = Math.round((prog / goal) * 100); $('#xpBar').style.width = `${pct}%`; $('#xpBar').textContent = `${pct}%`; $('#xpText').textContent = `${state.stats.xp} / ${nextRank.xp} XP`; }
            else { $('#xpBar').style.width = '100%'; $('#xpBar').textContent = 'Max Rank'; $('#xpText').textContent = `${state.stats.xp} XP`; }
            const achGrid = $('#achGrid'); achGrid.innerHTML = '';
            for (const id in ACHIEVEMENTS) { const a = ACHIEVEMENTS[id]; const unlocked = state.stats.achievements.includes(id); achGrid.innerHTML += `<div class="ach ${unlocked ? 'unlocked' : ''} p-2 text-center rounded border border-gray-300 dark:border-gray-600"><strong>${a.name}</strong><div class="text-xs text-secondary">${a.desc}</div></div>`; }
        }
        function checkAchievements() {
            const newlyUnlocked = [];
            const correctCount = state.userResponses.filter(r => r && r.isCorrect).length;
            if (!state.stats.achievements.includes('first_mission')) newlyUnlocked.push('first_mission');
            if (state.stats.correctAnswers >= 10 && !state.stats.achievements.includes('quick_learner')) newlyUnlocked.push('quick_learner');
            if (state.stats.totalQuestions >= 100 && !state.stats.achievements.includes('persistent_analyst')) newlyUnlocked.push('persistent_analyst');
            if (correctCount === state.currentQuiz.length && state.currentQuiz.length >= 10 && !state.stats.achievements.includes('perfectionist')) newlyUnlocked.push('perfectionist');
            if (newlyUnlocked.length > 0) { state.stats.achievements.push(...newlyUnlocked); saveStats(); newlyUnlocked.forEach(id => alert(`üèÜ Achievement Unlocked: ${ACHIEVEMENTS[id].name}!`)); }
        }
        function updateDailyFocusBtn() {
            const btn = $('#dailyFocusBtn');
            if (state.stats.dailyFocus.date !== today()) {
                state.stats.dailyFocus.count = 0;
            }
            const remaining = 2 - state.stats.dailyFocus.count;
            btn.disabled = remaining <= 0;
            if (btn.disabled) {
                btn.textContent = 'Daily Focus Completed';
            } else {
                btn.textContent = `üéØ Daily Focus (${remaining} remaining)`;
            }
        }
        
        // --- AI ASSIST ---
        async function handleAiAssist() {
            const qData = state.currentQuiz[state.currentIndex], uResp = state.userResponses[state.currentIndex];
            $('#aiAssistModal').classList.remove('hidden'); $('#aiAssistLoader').classList.remove('hidden'); $('#aiAssistResponse').classList.add('hidden');
            const prompt = `As a CISA tutor using the Socratic method, the user answered this question incorrectly: "${qData.question}". They chose "${qData.options[uResp.selectedIndex]}", but the correct answer was "${qData.options[qData.answer]}". The explanation was: "${qData.explanation}". **Do not give the answer directly.** Start by asking a clarifying question to help them understand the core concept they missed. Guide them to the 'aha!' moment.`;
            const response = await callGemini(prompt, false);
            $('#aiAssistResponse').innerHTML = response.text.replace(/\n/g, '<br>');
            $('#aiAssistLoader').classList.add('hidden');
            $('#aiAssistResponse').classList.remove('hidden');
        }

        // --- LOCAL STORAGE & STATS ---
        function saveStats() { localStorage.setItem('cisaAppStatsV6', JSON.stringify(state.stats)); }
        function loadStats() { const saved = localStorage.getItem('cisaAppStatsV6'); if (saved) { const loadedStats = JSON.parse(saved); state.stats = {...state.stats, ...loadedStats, achievements: loadedStats.achievements || [], dailyFocus: loadedStats.dailyFocus || {date: null, count: 0}}; } }
        function resetStats() { if (confirm("Reset all lifetime stats, rank, and XP? This cannot be undone.")) { state.stats = { totalQuestions:0, correctAnswers:0, xp:0, achievements:[], dailyFocus:{date:null, count:0}, performance:{domain1:{c:0,t:0},domain2:{c:0,t:0},domain3:{c:0,t:0},domain4:{c:0,t:0},domain5:{c:0,t:0}} }; saveStats(); alert("Stats reset."); updateServiceRecordUI(); } }
        async function checkApiKey() { const statusEl = $('#apiKeyStatus'); statusEl.textContent = 'Status: CHECKING...'; const res = await callGemini("test", false); statusEl.textContent = res && res.text && !res.text.includes("missing") ? 'Status: ‚úÖ VALID' : 'Status: ‚ùå INVALID/MISSING'; }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            applyTheme(localStorage.getItem('theme') || 'light');
            renderView('mainMenu');
            $('#startQuizBtn').addEventListener('click', () => startQuiz(false));
            $('#dailyFocusBtn').addEventListener('click', () => startQuiz(true));
            $('#exitQuizBtn').addEventListener('click', () => $('#exitModal').classList.remove('hidden'));
            $('#confirmExitBtn').addEventListener('click', () => { $('#exitModal').classList.add('hidden'); renderView('mainMenu'); });
            $('#cancelExitBtn').addEventListener('click', () => $('#exitModal').classList.add('hidden'));
            $('#nextBtn').addEventListener('click', () => navigate(1));
            $('#prevBtn').addEventListener('click', () => navigate(-1));
            $('#restartBtn').addEventListener('click', () => renderView('mainMenu'));
            $('#serviceRecordBtn').addEventListener('click', () => renderView('serviceRecordPanel'));
            $('#systemBtn').addEventListener('click', () => renderView('systemPanel'));
            $$('.backToMenuBtn').forEach(btn => btn.addEventListener('click', () => renderView('mainMenu')));
            $('#aiAssistBtn').addEventListener('click', handleAiAssist);
            $('#closeAiAssistModal').addEventListener('click', () => $('#aiAssistModal').classList.add('hidden'));
            $('#resetStatsBtn').addEventListener('click', resetStats);
            $('#checkApiKeyBtn').addEventListener('click', checkApiKey);
            $('#reviewMissionBtn').addEventListener('click', showReview);
            $('#backToResultsBtn').addEventListener('click', () => renderView('resultsPanel'));
        });
    </script>
</body>
</html>
